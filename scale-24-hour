#!/usr/bin/perl

@walk_scale = (
	641, 608, 488, 429,
	344, 339, 275, 428,
	411, 250, 178, 154,
	131, 122, 134, 94,
	100, 97, 155, 260,
	197, 261, 425, 680,
	638, 826, 1240, 1466,
	1627, 2188, 2506, 3042,
	2735, 2687, 2323, 2703,
	2082, 2058, 2327, 2215,
	1889, 1955, 1957, 2384,
	2953, 2568, 2912, 3461,
	3534, 3636, 3850, 3585,
	3337, 3274, 2912, 3094,
	3052, 3408, 3225, 3332,
	3003, 3697, 3553, 3866,
	3977, 4003, 4594, 4071,
	4513, 4176, 3734, 3660,
	3298, 3329, 3398, 3180,
	3136, 2771, 2688, 2582,
	2576, 2202, 2018, 1933,
	2001, 2055, 1854, 1505,
	1422, 1316, 1335, 1133,
	1073, 1015, 909, 828,
);

@drive_scale = (
	7326, 6370, 5473, 5005,
	4759, 4331, 3945, 3452,
	3663, 3321, 2709, 2405,
	2089, 1962, 1918, 1914,
	1957, 2310, 3139, 3713,
	4281, 6126, 9945, 11925,
	12962, 17721, 24770, 29838,
	33218, 41937, 49165, 52527,
	49808, 49173, 45994, 43002,
	36914, 34017, 33114, 32736,
	29737, 29299, 30698, 31683,
	32168, 33408, 34706, 35710,
	35719, 37019, 37639, 38206,
	37076, 37113, 38023, 37289,
	38900, 39738, 41577, 41053,
	42230, 44956, 49291, 50141,
	52722, 55279, 59480, 60344,
	62742, 63263, 60598, 56266,
	51388, 47094, 43152, 39794,
	36968, 34648, 32585, 30858,
	30075, 29277, 28043, 26472,
	27093, 24432, 22773, 20539,
	19107, 17526, 15869, 13855,
	13322, 11554, 10802, 8501,
);

for (my $i = 0; $i <= $#walk_scale; $i++) {
	$walk_sum += $walk_scale[$i];
}

for (my $i = 0; $i <= $#walk_scale; $i++) {
	$drive_sum += $drive_scale[$i];
}

sub out {
	if ($count[0] != 0) {
		print "$okey,00:00-24:00,";

		for ($i = 0; $i < 20; $i++) {
			printf("%.1f,", $sum[$i] / $count[$i]);
		}

		print "$where\n";
	}
}

while (<>) {
	chomp;
	($id, $name, $id2, $date, $time, @fields) = split(/,/);

	$key = "$id,$name,$id2,$date";
	if ($key ne $okey) {
		out();

		@sum = ();
		@count = ();
	}

	if ($time =~ /(\d+):(\d\d) *- *(\d+):(\d\d)/) {
		$start = $1 * 60 + $2;
		$end = $3 * 60 + $4;
		$dur = $end - $start;

		if ($start % 15 != 0 || $start >= 24 * 60 || $start < 0) {
			print STDERR "Don't know what to do with time $time\n";
			next;
		}

		if ($start < 6 * 60) {
			print STDERR "Don't believe $key $time is really in the middle of the night\n";
			next;
		}

		for ($t = $start; $t < $end; $t += 15) {
			for ($i = 0; $i < 12; $i++) {
				$sum[$i] += $fields[$i] * 15 / $dur * $drive_sum / $drive_scale[$t / 15];
				$count[$i]++;
			}
			$n = 0;
			for ($i = 12; $i < 20; $i++) {
				$sum[$i] += $fields[$i] * 15 / $dur * $walk_sum / $walk_scale[$t / 15];
				$n += $fields[$i] * 15 / $dur * $walk_sum / $walk_scale[$t / 15];
				$count[$i]++;
			}

			# print "predict $n for $key based on $time $fields[12] $fields[13] $fields[14] $fields[15]\n";
		}
	}

	$okey = $key;
	$where = "$fields[20],$fields[21]";
}

out();
