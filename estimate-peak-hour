#!/usr/bin/perl

@walk_scale = (
	0.157309, 0.149394, 0.121197, 0.104131,
	0.083354, 0.083107, 0.068761, 0.103636,
	0.100915, 0.061588, 0.044027, 0.036112,
	0.032154, 0.029186, 0.031660, 0.023377,
	0.023250, 0.022508, 0.037596, 0.063072,
	0.049709, 0.064985, 0.117378, 0.184864,
	0.146606, 0.203443, 0.285085, 0.349330,
	0.470668, 0.522188, 0.607571, 0.730771,
	0.681521, 0.662790, 0.721331, 0.825094,
	0.711668, 0.655524, 0.750877, 0.713612,
	0.623371, 0.578293, 0.604806, 0.711427,
	0.747092, 0.740656, 0.839980, 0.947224,
	1.043065, 1.078456, 1.129212, 1.103758,
	0.961336, 0.907791, 0.847272, 0.932791,
	0.913788, 0.905253, 0.853235, 0.828915,
	0.895561, 0.954944, 0.945053, 0.973939,
	0.986492, 0.974850, 1.070620, 1.000000,
	1.048751, 0.980036, 0.989286, 0.966448,
	0.907183, 0.903836, 0.882105, 0.809937,
	0.740508, 0.669631, 0.637939, 0.633480,
	0.633014, 0.537560, 0.494737, 0.463876,
	0.480373, 0.488272, 0.442556, 0.362614,
	0.344546, 0.322038, 0.326738, 0.276775,
	0.260945, 0.247836, 0.221123, 0.200743,
);

@drive_scale = (
	0.113852, 0.099033, 0.084650, 0.076914,
	0.074666, 0.068524, 0.062422, 0.054958,
	0.058308, 0.051675, 0.043694, 0.038450,
	0.036639, 0.035276, 0.034977, 0.034784,
	0.037430, 0.048338, 0.065159, 0.079270,
	0.099909, 0.143303, 0.252988, 0.277938,
	0.289094, 0.391374, 0.516157, 0.597329,
	0.634787, 0.757607, 0.869016, 0.920955,
	0.809834, 0.767999, 0.725188, 0.709432,
	0.617695, 0.596398, 0.595717, 0.603001,
	0.598552, 0.601926, 0.594243, 0.615619,
	0.619856, 0.647057, 0.686317, 0.716944,
	0.743574, 0.736643, 0.739372, 0.752006,
	0.734680, 0.720937, 0.738072, 0.740253,
	0.742520, 0.753377, 0.769224, 0.777068,
	0.802229, 0.828167, 0.882041, 0.872558,
	0.916460, 0.931935, 0.983134, 1.000000,
	1.073133, 1.075277, 1.017624, 0.938993,
	0.847724, 0.822242, 0.744076, 0.675416,
	0.608862, 0.591143, 0.549223, 0.512429,
	0.455683, 0.435029, 0.410117, 0.383884,
	0.379503, 0.343024, 0.316348, 0.275818,
	0.295922, 0.280565, 0.252273, 0.216878,
	0.209956, 0.184745, 0.169777, 0.133902,
);

for (my $i = 0; $i <= $#walk_scale; $i++) {
	$walk_sum += $walk_scale[$i];
}

for (my $i = 0; $i <= $#walk_scale; $i++) {
	$drive_sum += $drive_scale[$i];
}

my $walk_peak = 0;
for (my $i = 0; $i + 3 <= $#walk_scale; $i++) {
	my $p = $walk_scale[$i] + $walk_scale[$i + 1] + $walk_scale[$i + 2] + $walk_scale[$i + 3];
	if ($p > $walk_peak) {
		$walk_peak = $p;
		$walk_peak_when = $i;
	}
}

my $drive_peak = 0;
for (my $i = 0; $i + 3 <= $#drive_scale; $i++) {
	my $p = $drive_scale[$i] + $drive_scale[$i + 1] + $drive_scale[$i + 2] + $drive_scale[$i + 3];
	if ($p > $drive_peak) {
		$drive_peak = $p;
		$drive_peak_when = $i;

		$walk_peak = $walk_scale[$i] + $walk_scale[$i + 1] + $walk_scale[$i + 2] + $walk_scale[$i + 3];
	}
}

$time_peak = sprintf("%02d:%02d-%02d:%02d",
	int($drive_peak_when / 4), ($drive_peak_when % 4) * 15,
	int($drive_peak_when / 4 + 1), ($drive_peak_when % 4) * 15);

sub out {
	if ($count[0] != 0) {
		print "$okey,$time_peak,";

		for ($i = 0; $i < 20; $i++) {
			printf("%.1f,", $sum[$i] / $count[$i]);
		}

		print "$where\n";
	}
}

while (<>) {
	chomp;
	($id, $name, $id2, $date, $time, @fields) = split(/,/);

	$key = "$id,$name,$id2,$date";
	if ($key ne $okey) {
		out();

		@sum = ();
		@count = ();
	}

	if ($time =~ /(\d+):(\d\d) *- *(\d+):(\d\d)/) {
		$start = $1 * 60 + $2;
		$end = $3 * 60 + $4;
		$dur = $end - $start;

		if ($start >= 24 * 60 || $end > 24 * 60 || $start < 0 || $dur == 0) {
			print STDERR "Don't know what to do with time $time\n";
			next;
		}

		if ($start < 6 * 60) {
			print STDERR "Don't believe $key $time is really in the middle of the night\n";
			next;
		}

		for ($t = $start; $t < $end; $t += 15) {
			for ($i = 0; $i < 12; $i++) {
				if ($dur == 0 || $drive_scale[$t / 15] == 0) {
					print STDERR "$_\n";
				}
				$sum[$i] += $fields[$i] * 15 / $dur * $drive_sum / $drive_scale[$t / 15] * $drive_peak / $drive_sum;
				$count[$i]++;
			}
			$n = 0;
			for ($i = 12; $i < 20; $i++) {
				$sum[$i] += $fields[$i] * 15 / $dur * $walk_sum / $walk_scale[$t / 15] * $walk_peak / $walk_sum;
				$n += $fields[$i] * 15 / $dur * $walk_sum / $walk_scale[$t / 15] * $walk_peak / $walk_sum;
				$count[$i]++;
			}

			# print "predict $n for $key based on $time $fields[12] $fields[13] $fields[14] $fields[15]\n";
		}
	}

	$okey = $key;
	$where = "$fields[20],$fields[21]";
}

out();
